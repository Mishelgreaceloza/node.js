
import express from "express"
import path from "path"//para
import {fileURLToPath} from "url"//para la url
import {createServer}from "node:http"//crea servidores http
import {Server} from "socket.io"//tiempo real

const port=process.env.PORT ?? 3000;
const app=express()//servidor sin http
const server=createServer(app)//creamos el servidor http
const io=new Server(server,{connectionStateRecovery:{}})//nuevo servidor http y express

const usuarios={}//ten aca se guarda los usuarios 
const historial={}
const LIMITE_MENSAJES =50

const __filename=fileURLToPath(import.meta.url);//url para el index
const __dirname=path.dirname(__filename);//url para el index
app.use(express.static(path.join(__dirname,"../cliente")))//url para el index



app.get("/",(req,res)=>{
	res.sendFile(path.join(__dirname,"..","cliente","index.html"))
	})//obtiene la ruta y muestra el index.html


io.on("connection",(socket)=>{

	//ENTRA a la sala general----
	//socket.join("general")
	console.log("se conecto usuario ",socket.id)//cada que alguien abre la pagina
	
	//usuario se CONECTA----
	socket.on("nuevoUsuario",(nombre)=>{
			usuarios[socket.id]=nombre//es donde el usuario y su id se conectan 
			console.log("usuarios conectados",usuarios);
			io.emit("listaUsuarios",Object.values(usuarios))//lista de conectados 
		})

	//entrar y salir de una SALA-----
	socket.on("cambiarSala", ({anterior,nueva}) => {
    	if(anterior) {socket.leave(anterior)}//LEAVE sale de la sala
    	socket.join(nueva);//JOIN agrupa los usuarios a  la nueva sala 
    	console.log(`Usuario ${usuarios[socket.id]} salio ${anterior} entrÃ³ a ${nueva}`);
  		
  		//enviamos el historial al que entra o0
  		if(historial[nueva]){
  			socket.emit("historial",historial[nueva])
  		}
  	});

	//envia los MENSAJES------

  	socket.on("chat mensaje", (msg) => {
  		if(!msg?.mensaje|| !msg.sala) return//evita que caiga
  		const ahora = new Date()
  		const mensajeCompleto={
  			sala:msg.sala,
  			nombre:usuarios[socket.id],
  			mensaje:msg.mensaje,
  			hora: ahora.toLocaleTimeString([],{
  				hour:"2-digit",
  				minute:"2-digit"
  			})
  		}

//------HISTORIAL si la sala no existe la creamos 

  		if(!historial[msg.sala]){
  			historial[msg.sala]=[]
  		}
  		//guarmos el mensaje 
  		historial[msg.sala].push(mensajeCompleto)

  		//limitamos el historial 
  		if (historial[msg.sala].length >LIMITE_MENSAJES) {
  			historial[msg.sala].shift()
  		}

  		console.log("mensaje es",mensajeCompleto);
    	io.to(msg.sala).emit("chat mensaje",  	mensajeCompleto)
    	//io.to solo los que estan unido a la sala ;
 });
	
 //---------escribiendo..

  	socket.on("escribiendo", ({ sala }) => {
  	socket.to(sala).emit("escribiendo", { nombre:usuarios[socket.id]});
	});

	socket.on("dejoDeEscribir", ({ sala }) => {
  	socket.to(sala).emit("dejoDeEscribir");
	});


//cuando se DESCONECTA-----
	socket.on("disconnect",()=>{
		console.log("usuario salio",usuarios[socket.id])
		delete usuarios[socket.id];
		io.emit("listaUsuarios",Object.values(usuarios))
	})//cuando el usuario se desconcta 



})

server.listen(port,()=>{
	console.log("coriendo");
})




