import express from "express"
import path from "path"//para
import {fileURLToPath} from "url"//para la url
import {createServer}from "node:http"//crea servidores http
import {Server} from "socket.io"//tiempo real

const port=process.env.PORT ?? 3000;
const app=express()//servidor sin http
const server=createServer(app)//creamos el servidor http
const io=new Server(server,{connectionStateRecovery:{}})//nuevo servidor http y express

const usuarios={}//en aca se guarda los usuarios 

const __filename=fileURLToPath(import.meta.url);//url para el index
const __dirname=path.dirname(__filename);//url para el index
app.use(express.static(path.join(__dirname,"../cliente")))//url para el index

const historial={}
const LIMITE_MENSAJES =50


app.get("/",(req,res)=>{
	res.sendFile(path.join(__dirname,"..","cliente","index.html"))
	})//obtiene la ruta y muestra el index.html


io.on("connection",(socket)=>{

//ENTRA a la sala general----------------------------------------
		socket.join("general")
		console.log("se conecto usuario ",socket.id)//cada que alguien abre la pagina
	
//usuario se CONECTA---------------------------------------------
		socket.on("nuevoUsuario",(nombre)=>{
			usuarios[socket.id]=nombre//es donde el usuario y su id se conectan 
			console.log("usuarios conectados",usuarios);
			io.emit("listaUsuarios",Object.values(usuarios))//lista de conectados 
		})



script type="module">
  import { io } from "https://cdn.socket.io/4.7.5/socket.io.esm.min.js";

  const socket = io();
  const form=document.getElementById("formulario")
  const input=document.getElementById("input")
  const mensajes=document.getElementById("mensaje")
  const userConectados=document.getElementById("usuarioConetados")
  const salaSelect = document.getElementById("sala");
  const btnEntrar = document.getElementById("entrar");
  const escribiendoP=document.getElementById("escribiendo")
  const tituloChat=document.getElementById("tituloChat")

//USUARIO-------------------------------------- como se aÃ±ade,donde se guarda 
    let nombre=localStorage.getItem("apodo")// no se bore su nombre del usuario 
    if(!nombre){
      nombre=prompt("cual es tu nombre")
    if(!nombre)nombre= "anonimo"//vacio sera anonimo
      localStorage.setItem("apodo",nombre)//donde se guarda 
    }

    //let salaActual = "general";
    socket.on("connect",()=>{
    socket.emit("nuevoUsuario",nombre)//socket.emit("unirseSala",salaActual)
  }
