
<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>mi chat</title>
	
<style>
  #mensaje {
    list-style: none;
    padding: 10px;
  }

  #mensaje li {
    margin: 6px 0;
    padding: 8px 12px;
    max-width: 70%;
    border-radius: 10px;
    word-wrap: break-word;
  }

  .mio {
    background-color: #dcf8c6;
    margin-left: auto;
    text-align: right;
  }

  .otro {
    background-color: #f1f0f0;
    margin-right: auto;
    text-align: left;
  }
  .hora{
    font-size: 0.75em;
    color: #666;
    margin-left: 6px ;
  }
  .mensaje{
    margin: 6px 0;
    padding: 8px 12px;
  }
  </style>
</head>
<body>
	<section id="chat">
    <div class="salas">
    <select id="sala">
    <option value="general">General</option>
    <option value="javascript">JavaScript</option>
    <option value="ayuda">Ayuda</option>
    </select>
    <button id="entrar">Entrar</button>
  </div>
    <h3>usuarios conectados</h3>
    <ul id="usuarioConetados"></ul>
    <!--titulo chat-->
    <h2 id="tituloChat"></h2>
    <ul id="mensaje"></ul>
    <p id="escribiendo" style="font-style: italic; color: gray;"></p>
		<!--formulario-->
    <form id="formulario">
			<input type="text" name="message" id="input" placeholder="pon un mensaje " autocomplete="off"/>
			<button  type=submit>enviar </button>

		</form>
	</section>


<script type="module">
  import { io } from "https://cdn.socket.io/4.7.5/socket.io.esm.min.js";

  const socket = io();
  const form=document.getElementById("formulario")
  const input=document.getElementById("input")
  const mensajes=document.getElementById("mensaje")
  const userConectados=document.getElementById("usuarioConetados")
  const salaSelect = document.getElementById("sala");
  const btnEntrar = document.getElementById("entrar");
  const escribiendoP=document.getElementById("escribiendo")
  const tituloChat=document.getElementById("tituloChat")

//USUARIO-------------------------------------- como se añade,donde se guarda 
    let nombre=localStorage.getItem("apodo")// no se bore su nombre del usuario 
    let esNuevo=false
    if(!nombre){
      nombre=prompt("cual es tu nombre")
      if(!nombre)nombre= "anonimo"//vacio sera anonimo
        localStorage.setItem("apodo",nombre)//donde se guarda 
        esNuevo=true
    }
   

    let salaActual = "general";

    socket.on("connect",()=>{
      console.log("contado al sevidor");
      socket.emit("nuevoUsuario",nombre)

    if(esNuevo){//si es nuevo a la sala 
      socket.emit("cambiarSala",{
        anterior:null,
        nueva:"general"
      })
    salaActual="general"
    vistaGrupos.style.display="none"
    vistaChat.style.display="block"

    tituloChat.textContent="sala general"
    }else{
      vistaGrupos.style.display="block"
      vistaChat.style.display="none"
    }
    
  //SALAS----------------------------------------------------
    
    socket.emit("cambiarSala",{
      anterior:null,
      nueva:salaActual
    })
       })
    btnEntrar.addEventListener("click", () => {
        const nuevaSala = salaSelect.value;
        socket.emit("cambiarSala",{
          anterior:salaActual,
          nueva:nuevaSala});//unirse a la sala
        salaActual=nuevaSala//cual salir cual entrar
        mensajes.innerHTML = ""; // limpiamos mensajes al cambiar
    tituloChat.textContent =`sala: ${salaActual}`
    });
 
//USUARIOS conectados ---------------------------------------
  socket.on("listaUsuarios",(usuarios)=>{
    userConectados.innerHTML=""
    usuarios.forEach((u)=>{
      
      if (u === nombre) return;

    const li = document.createElement("li");
    li.textContent = u;
    li.style.cursor = "pointer";
    userConectados.appendChild(li)
    //})
    //})

//ELEGIR USUARIO PRIV-----------------------------------
    li.addEventListener("click", () => {
      //chatPrivadoCon = u;

      const salaPrivada=[nombre,u].sort().join("-")
        
      console.log("click en usuario",u);
      console.log("cambio de sala",salaActual,"a",salaPrivada);
      socket.emit("cambiarSala",{
        anterior:salaActual,
        nueva:salaPrivada
      })

      salaActual=salaPrivada
      mensajes.innerHTML = "";
      tituloChat.textContent = `Chat con ${u}`;
    });

    userConectados.appendChild(li);
      
    //para la los usuarios conectados 
  })
  })

//ENVIAR el mensaje ----
   form.addEventListener("submit",(e)=>{
    e.preventDefault()//evita que la pagina se r0..0.
    
    socket.emit("dejoDeEscribir",{
      sala:salaActual
    })

    const texto=input.value.trim()
    if(!texto)
     return
      socket.emit("chat mensaje",{//laza la pelota al serv
        mensaje:texto,
        sala:salaActual }) 
      input.value="" //limpia el cuadro para next text
    })//cuando apretemos el boton enviar
   
   //MOSTRAR EL MENSAJE-------

      //texto
          socket.off("chat mensaje");
          socket.on("chat mensaje",(msg)=>{

          const li=document.createElement("li")
      
          
          li.className = msg.nombre === nombre ? "mio" : "otro";
          li.innerHTML = msg.nombre === nombre
            ? `<span class="hora">${msg.hora}</span>${msg.mensaje}`
            :`<strong class="usuario" data-nombre="${msg.nombre}">${msg.nombre}</strong>: </span class="hora"> ${msg.hora}</span><br>
            ${msg.mensaje}`;
              mensajes.appendChild(li)  
          mensajes.scrollTop=mensajes.scrollHeight
        })

      //ususario a privadao 

        mensajes.addEventListener("click",(e)=>{
          if(e.target.classList.contains("usuario")){
            const otroUsuario=e.target.dataset.nombre
            if(otroUsuario=== nombre)return
            const salaPrivada=[nombre,otroUsuario].sort().join("-")
          socket.emit("cambiarSala",{
            anterior:salaActual,
            nueva:salaPrivada
          })
          salaActual=salaPrivada
          mensajes.innerHTML=""
          tituloChat.textContent=`chat con ${otroUsuario}`
          }
        })
      //HISTORIAL-------------------------------------
        socket.on("historial", (mensajesHistorial) => {
        mensajes.innerHTML = ""; // limpiamos

        mensajesHistorial.forEach((msg) => {
          const li = document.createElement("li");

          li.className = msg.nombre === nombre ? "mio" : "otro";

          li.innerHTML =
            msg.nombre === nombre
              ? `<span class="hora">${msg.hora}</span> ${msg.mensaje}`
              : `<strong class="usuario" data-nombre="${msg.nombre}">${msg.nombre}</strong>
                 <span class="hora">${msg.hora}</span><br>
                 ${msg.mensaje}`;

          mensajes.appendChild(li);
        });
          mensajes.scrollTop = mensajes.scrollHeight;
        });

         
      //escribiendo.....
      let estaEscribiendo=false
      let timeoutEscribiendo

      input.addEventListener("input",()=>{
        if(!estaEscribiendo){
          estaEscribiendo=true
          socket.emit("escribiendo",{
            sala:salaActual
          })
        }
        clearTimeout(timeoutEscribiendo);

        timeoutEscribiendo=setTimeout(()=>{
          estaEscribiendo=false
          socket.emit("dejoDeEscribir",{
            sala:salaActual
          })
        },1000);
      })  

      socket.on("escribiendo", (msg) => {
      if (msg.nombre !== nombre) {
        escribiendoP.textContent = `${msg.nombre} está escribiendo...`;
      }
    });

    socket.on("dejoDeEscribir", () => {
      escribiendoP.textContent = "";
    });


  
</script>

</body>


</html>

