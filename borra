
import express from "express"
import path from "path"//para
import {fileURLToPath} from "url"//para la url
import {createServer}from "node:http"//crea servidores http
import {Server} from "socket.io"//tiempo real

const port=process.env.PORT ?? 3000;
const app=express()//servidor sin http
const server=createServer(app)//creamos el servidor http
const io=new Server(server,{connectionStateRecovery:{}})//nuevo servidor http y express

const usuarios={}//ten aca se guarda los usuarios 
const historial={}
const LIMITE_MENSAJES =50

const __filename=fileURLToPath(import.meta.url);//url para el index
const __dirname=path.dirname(__filename);//url para el index
app.use(express.static(path.join(__dirname,"../cliente")))//url para el index



app.get("/",(req,res)=>{
	res.sendFile(path.join(__dirname,"..","cliente","index.html"))
	})//obtiene la ruta y muestra el index.html


io.on("connection",(socket)=>{

	//ENTRA a la sala general----
	//socket.join("general")
	console.log("se conecto usuario ",socket.id)//cada que alguien abre la pagina
	
	//usuario se CONECTA----
	socket.on("nuevoUsuario",(nombre)=>{
			usuarios[socket.id]=nombre//es donde el usuario y su id se conectan 
			console.log("usuarios conectados",usuarios);
			io.emit("listaUsuarios",Object.values(usuarios))//lista de conectados 
		})

	//entrar y salir de una SALA-----
	socket.on("cambiarSala", ({anterior,nueva}) => {
    	if(anterior) {socket.leave(anterior)}//LEAVE sale de la sala
    	socket.join(nueva);//JOIN agrupa los usuarios a  la nueva sala 
    	console.log(`Usuario ${usuarios[socket.id]} salio ${anterior} entró a ${nueva}`);
  		
  		//enviamos el historial al que entra o0
  		if(historial[nueva]){
  			socket.emit("historial",historial[nueva])
  		}
  	});

	//envia los MENSAJES------

  	socket.on("chat mensaje", (msg) => {
  		if(!msg?.mensaje|| !msg.sala) return//evita que caiga
  		const ahora = new Date()
  		const mensajeCompleto={
  			sala:msg.sala,
  			nombre:usuarios[socket.id],
  			mensaje:msg.mensaje,
  			hora: ahora.toLocaleTimeString([],{
  				hour:"2-digit",
  				minute:"2-digit"
  			})
  		}

//------HISTORIAL si la sala no existe la creamos 

  		if(!historial[msg.sala]){
  			historial[msg.sala]=[]
  		}
  		//guarmos el mensaje 
  		historial[msg.sala].push(mensajeCompleto)

  		//limitamos el historial 
  		if (historial[msg.sala].length >LIMITE_MENSAJES) {
  			historial[msg.sala].shift()
  		}

  		console.log("mensaje es",mensajeCompleto);
    	io.to(msg.sala).emit("chat mensaje",  	mensajeCompleto)
    	//io.to solo los que estan unido a la sala ;
 });
	
 //---------escribiendo..

  	socket.on("escribiendo", ({ sala }) => {
  	socket.to(sala).emit("escribiendo", { nombre:usuarios[socket.id]});
	});

	socket.on("dejoDeEscribir", ({ sala }) => {
  	socket.to(sala).emit("dejoDeEscribir");
	});


//cuando se DESCONECTA-----
	socket.on("disconnect",()=>{
		console.log("usuario salio",usuarios[socket.id])
		delete usuarios[socket.id];
		io.emit("listaUsuarios",Object.values(usuarios))
	})//cuando el usuario se desconcta 



})

server.listen(port,()=>{
	console.log("coriendo");
})

en app.js:

import { io } from "https://cdn.socket.io/4.7.5/socket.io.esm.min.js";
import {mostrarMensaje,mostrarUsuarios,mostaraHistorial}from "./vistas.js"
  const socket = io();
  const form=document.getElementById("formulario")
  const input=document.getElementById("input")
  const mensajes=document.getElementById("mensaje")
  const userConectados=document.getElementById("usuarioConetados")
  const salaSelect = document.getElementById("sala");
  const btnEntrar = document.getElementById("entrar");
  const escribiendoP=document.getElementById("escribiendo")
  const tituloChat=document.getElementById("tituloChat")

//USUARIO-------------------------------------- como se añade,donde se guarda 
    let nombre=localStorage.getItem("apodo")// no se bore su nombre del usuario 
    let esNuevo=false
    if(!nombre){
      nombre=prompt("cual es tu nombre")
      if(!nombre)nombre= "anonimo"//vacio sera anonimo
        localStorage.setItem("apodo",nombre)//donde se guarda 
        esNuevo=true
    }
   

    let salaActual = "general";

    socket.on("connect",()=>{
      console.log("contado al sevidor");
      socket.emit("nuevoUsuario",nombre)

    if(esNuevo){//si es nuevo a la sala 
      socket.emit("cambiarSala",{
        anterior:null,
        nueva:"general"
      })
    salaActual="general"
    //vistaGrupos.style.display="none"
    //vistaChat.style.display="block"

    tituloChat.textContent="sala general"
    }else{
      //vistaGrupos.style.display="block"
      //vistaChat.style.display="none"
    }
    
  //SALAS----------------------------------------------------
    
    socket.emit("cambiarSala",{
      anterior:null,
      nueva:salaActual
    })
       })
    btnEntrar.addEventListener("click", () => {
        const nuevaSala = salaSelect.value;
        socket.emit("cambiarSala",{
          anterior:salaActual,
          nueva:nuevaSala});//unirse a la sala
        salaActual=nuevaSala//cual salir cual entrar
        mensajes.innerHTML = ""; // limpiamos mensajes al cambiar
    tituloChat.textContent =`sala: ${salaActual}`
    });
 
//USUARIOS conectados  mostrar ---------------------------------------
  socket.on("listaUsuarios",(usuarios)=>{
    
   mostrarUsuarios(
    userConectados,usuarios,nombre,(u)=>{

//ELEGIR USUARIO PRIV-----------------------------------
      const salaPrivada=[nombre,u].sort().join("-")
        
      console.log("click en usuario",u);
      console.log("cambio de sala",salaActual,"a",salaPrivada);
      socket.emit("cambiarSala",{
        anterior:salaActual,
        nueva:salaPrivada
      })

      salaActual=salaPrivada
      mensajes.innerHTML = "";
      tituloChat.textContent = `Chat con ${u}`;
    }
   )
  })

//ENVIAR el mensaje ----
   form.addEventListener("submit",(e)=>{
    e.preventDefault()//evita que la pagina se r0..0.
    
    socket.emit("dejoDeEscribir",{
      sala:salaActual
    })

    const texto=input.value.trim()
    if(!texto)
     return
      socket.emit("chat mensaje",{//laza la pelota al serv
        mensaje:texto,
        sala:salaActual }) 
      input.value="" //limpia el cuadro para next text
    })//cuando apretemos el boton enviar
   
   //MOSTRAR EL MENSAJE-------

      //texto
          //socket.off("chat mensaje");
          socket.on("chat mensaje",(msg)=>{

          //----vistas------
            mostrarMensaje(mensajes,msg,nombre)
        })

      //ususario a privadao 

        mensajes.addEventListener("click",(e)=>{
          if(e.target.classList.contains("usuario")){
            const otroUsuario=e.target.dataset.nombre
            if(otroUsuario=== nombre)return
            const salaPrivada=[nombre,otroUsuario].sort().join("-")
          socket.emit("cambiarSala",{
            anterior:salaActual,
            nueva:salaPrivada
          })
          salaActual=salaPrivada
          mensajes.innerHTML=""
          tituloChat.textContent=`chat con ${otroUsuario}`
          }
        })
      //HISTORIAL-------------------------------------
        socket.on("historial", (mensajesHistorial) => {
          mostrarHistorial("historial",(mensajes,mensajesHistorial,nombre)
 /*      mensajes.innerHTML = ""; // limpiamos

        mensajesHistorial.forEach((msg) => {
          const li = document.createElement("li");

          li.className = msg.nombre === nombre ? "mio" : "otro";

          li.innerHTML =
            msg.nombre === nombre
              ? `<span class="hora">${msg.hora}</span> ${msg.mensaje}`
              : `<strong class="usuario" data-nombre="${msg.nombre}">${msg.nombre}</strong>
                 <span class="hora">${msg.hora}</span><br>
                 ${msg.mensaje}`;

          mensajes.appendChild(li);
        });
          mensajes.scrollTop = mensajes.scrollHeight;*/
        });

         
      //escribiendo.....
      let estaEscribiendo=false
      let timeoutEscribiendo

      input.addEventListener("input",()=>{
        if(!estaEscribiendo){
          estaEscribiendo=true
          socket.emit("escribiendo",{
            sala:salaActual
          })
        }
        clearTimeout(timeoutEscribiendo);

        timeoutEscribiendo=setTimeout(()=>{
          estaEscribiendo=false
          socket.emit("dejoDeEscribir",{
            sala:salaActual
          })
        },1000);
      })  

      socket.on("escribiendo", (msg) => {
      if (msg.nombre !== nombre) {
        escribiendoP.textContent = `${msg.nombre} está escribiendo...`;
      }
    });

    socket.on("dejoDeEscribir", () => {
      escribiendoP.textContent = "";
    });


  y en vistas.js


//USUARIOS CONECTADOS-------
export function mostrarUsuarios(listaElemento,usuarios,nombreActual,alClickUsuario){
  listaElemento.innerHTML=""
  usuarios.forEach((u)=>{
    if(u===nombreActual)return
    const li=document.createElement("li")
    li.textContent=u
    li.style.cursor="pointer"
    li.addEventListener("click",()=>{
      alClickUsuario(u)
    })
    listaElemento.appendChild(li)
  })
}
//MENSAJES------para mostrar los mensajes 
export function mostrarMensaje(mensajes,msg,nombre){
const li=document.createElement("li")
      
          
          li.className = msg.nombre === nombre ? "mio" : "otro";
          li.innerHTML = msg.nombre === nombre
            ? `<span class="hora">${msg.hora}</span>${msg.mensaje}`
            :`<strong class="usuario" data-nombre="${msg.nombre}">${msg.nombre}</strong>: <span class="hora"> ${msg.hora}</span><br>
            ${msg.mensaje}`;
              mensajes.appendChild(li)  
          mensajes.scrollTop=mensajes.scrollHeight
        }
//HISTORIAL--------------
export function mostrarHistorial(listaElemento,mensajesHistorial,nombreActual){
        listaElemento.innerHTML = ""; // limpiamos

        mensajesHistorial.forEach((msg) => {
          const li = document.createElement("li");

          li.className = msg.nombre === nombreActual ? "mio" : "otro";

          li.innerHTML =
            msg.nombre === nombreActual
              ? `<span class="hora">${msg.hora}</span> ${msg.mensaje}`
              : `<strong class="usuario" data-nombre="${msg.nombre}">${msg.nombre}</strong>
                 <span class="hora">${msg.hora}</span><br>
                 ${msg.mensaje}`;

          listaElemento.appendChild(li);
        });
          listaElemento.scrollTop = mensajes.scrollHeight;
}
